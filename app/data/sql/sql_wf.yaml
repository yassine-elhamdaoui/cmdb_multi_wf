check_workflow_runs_table: > 
  SELECT COUNT(*) FROM all_tables
    WHERE table_name = 'WORKFLOW_RUNS'

check_workflow_tasks_table: >
  SELECT COUNT(*) FROM all_tables 
    WHERE table_name = 'WORKFLOW_TASKS'

create_workflow_runs_table: >
  CREATE TABLE workflow_runs (
        id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY, 
        workflow_name VARCHAR(255),
        execution_date TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        state VARCHAR(50) check (state IN ('new','running', 'finished', 'error')),
        PRIMARY KEY(id)
    )

create_workflow_tasks_table: >
  CREATE TABLE workflow_tasks (
        id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY, 
        task_name VARCHAR(255),
        workflow_run_id NUMBER,
        type VARCHAR(50),
        state VARCHAR(50)  check (state IN ('new','running', 'finished', 'error')),
        start_time  TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
        end_time TIMESTAMP,
        result CLOB,
        FOREIGN KEY (workflow_run_id) REFERENCES workflow_runs(id),
        PRIMARY KEY(id)
    )

add_workflow_run: >
  INSERT INTO workflow_runs (workflow_name, execution_date, state) VALUES (:1, :2, :3) returning id INTO :new_id

add_workflow_task: >
  INSERT INTO workflow_tasks (task_name, workflow_run_id, type, state, start_time, end_time) VALUES (:1, :2, :3, :4, :5, :6)  returning id INTO :new_id

update_workflow_run: >
  UPDATE workflow_runs SET state = :1 WHERE id = :2

update_workflow_task: >
  UPDATE workflow_tasks SET state = :1, END_TIME=decode(:2,'finished',CURRENT_TIMESTAMP,null) WHERE id = :3

update_workflow_task_result: >
  UPDATE workflow_tasks SET state = :1, END_TIME=decode(:2,'finished',CURRENT_TIMESTAMP,null), result = :3 WHERE id = :4

exists_workflow_run: >
  Select count(*) num_wf_runs from workflow_runs WHERE workflow_name = :workflow_name

exists_workflow_task: >
  Select count(*) num_wf_task_runs from workflow_tasks WHERE task_name = :task_name

get_last_workflow_run: >
  Select MAX(execution_date) as last_execution_date from workflow_runs WHERE workflow_name = :workflow_name 

get_workflow_task_result: >
  select wt1.result from workflow_tasks wt1, workflow_tasks wt2 where wt2.id= :1 and wt1.task_name=:2 and wt1.WORKFLOW_RUN_ID = wt2.WORKFLOW_RUN_ID
